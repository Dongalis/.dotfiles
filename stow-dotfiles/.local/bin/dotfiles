#!/usr/bin/env bash
set -euo pipefail

DISPATCHER_CMD="$(basename "$0")"
LIB_DIR="$HOME/.local/lib/dotfiles"



SUBCMD="${1:-}"
shift || true

if [[ -z "$SUBCMD" ]]; then
  echo "Usage: dotfiles <command> [args...]"
  echo
  echo "Commands:"
  for file in "$LIB_DIR"/*.sh; do
    [[ -e "$file" ]] || continue
    cmd="$(basename "$file" .sh)"

    [[ "$cmd" == "core" ]] && continue

    printf "  %s\n" "$cmd"
  done
  exit 1
fi

if [[ "$SUBCMD" == "core" ]]; then
  echo "dotfiles: unknown command '$SUBCMD'" >&2
  exit 1
fi

CMD="$LIB_DIR/$SUBCMD.sh"

if [[ ! -f "$CMD" ]]; then
  echo "dotfiles: unknown command '$SUBCMD'" >&2
  exit 1
fi

if [[ ! -f "$CMD" ]]; then
  echo "dotfiles: unknown command '$SUBCMD'" >&2
  exit 1
fi

export DISPATCHER_CMD SUBCMD

exec "$CMD" "$@"
